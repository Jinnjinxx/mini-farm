<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>미니 농사 6×6 + 인벤토리</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121820; --panel-2:#18202a; --text:#e8eef6; --soil:#b08b67;
    --blue:#1e90ff; --blue-strong:#0d6efd; --blue-press:#0057d9; --blue-ring:#66b3ff55;
    --slot:#0c1218; --slot-border:#2a3947; --slot-sel:#66b3ff66;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD 산돌고딕 Neo","Malgun Gothic",Segoe UI,Roboto,Noto Sans,sans-serif;
    -webkit-text-size-adjust:100%;
  }
  .wrap{display:grid;grid-template-rows:auto 1fr auto;gap:10px;max-width:900px;margin:0 auto;padding:10px}
  .topbar{
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid #23303c;border-radius:14px;padding:10px;position:sticky;top:0;z-index:10
  }
  .pill{padding:8px 12px;border-radius:999px;background:#0c1218;border:1px solid #23303c;white-space:nowrap;font-size:14px}
  .grow{flex:1}

  .btn{
    appearance:none;border:1px solid #2a3947;background:#0c1218;color:var(--text);
    padding:12px 14px;border-radius:12px;cursor:pointer;transition:transform .02s,opacity .2s,background .12s,box-shadow .12s,border-color .12s;
    font-size:16px;line-height:1;text-align:center;touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  }
  .btn:active{transform:translateY(1px)}
  .btn-accent{background:var(--blue);color:#061225;border-color:#0b56a5;font-weight:700;box-shadow:0 1px 0 #00000060}
  .btn-accent:hover{background:var(--blue-strong)}
  .btn-accent:active{background:var(--blue-press);box-shadow:inset 0 2px 6px #00000055}
  .btn-accent:focus-visible{outline:none;box-shadow:0 0 0 3px var(--blue-ring)}
  .btn-house{background:#7bd88f;color:#06230e;border-color:#2f7c50;font-weight:700}

  .board-wrap{display:grid;grid-template-columns:1fr;gap:10px}
  .board{background:#0c1015;border:1px solid #23303c;border-radius:14px;padding:10px;display:grid;place-items:center;position:relative}

  /* 6x6 그리드 */
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;width:min(96vw,520px);aspect-ratio:1/1;touch-action:manipulation}
  .tile{
    border:1px solid #3a2f25;border-radius:8px;background:var(--soil);
    display:grid;place-items:center;user-select:none;cursor:pointer;
    transition:filter .15s,transform .02s;background-size:cover;background-position:center
  }
  .tile:active{transform:translateY(1px)}
  .tile[data-state="ready"]{box-shadow:inset 0 0 0 2px rgba(255,255,255,.09),0 0 0 2px rgba(255,255,255,.03)}

  /* 캐릭터 */
  #player{
    position:absolute; width:28px; height:28px; transform:translate(-50%,-100%);
    border-radius:50%; background: radial-gradient(ellipse at 40% 35%, #ffd8b5 30%, #e7a87a 31%, #8ab4ff 65%);
    border:2px solid #0a0f14; box-shadow:0 2px 6px rgba(0,0,0,.35); pointer-events:none; z-index:5;
  }

  .legend{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #23303c;border-radius:14px;padding:12px}
  .legend h3{margin:0 0 8px 0;font-size:16px}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .small{font-size:13px;color:#9fb0c2}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b0f14;border:1px solid #2a3440;border-radius:6px;padding:3px 7px}

  /* ─── 인벤토리 모달 ─── */
  .inventory{display:none;position:fixed;inset:0;backdrop-filter:blur(3px);background:rgba(0,0,0,.45);place-items:center;z-index:60}
  .inventory .card{background:#0f141a;border:1px solid #2f3945;border-radius:16px;padding:16px;max-width:520px;width:calc(100% - 24px)}
  .inventory h2{margin:0 0 12px 0;font-size:18px}
  .inventory-grid{
    display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:96px;gap:10px;
  }
  .slot{
    position:relative; border:1px solid var(--slot-border); border-radius:12px; background:var(--slot);
    display:grid;place-items:center; overflow:hidden;
  }
  .slot.selected{ outline:3px solid var(--slot-sel) }
  .slot img{ width:62px; height:62px; image-rendering:pixelated; object-fit:contain; pointer-events:none }
  .slot .label{position:absolute;left:8px;top:6px;font-size:12px;color:#9fb0c2}
  .slot .count{
    position:absolute; right:4px; bottom:2px; font-weight:800; font-size:14px; color:#ffffff;
    /* 2px 아웃라인: 웹킷 스트로크 + 멀티 섀도우 */
    -webkit-text-stroke:2px #000;
    text-shadow:
      1px 0 #000, -1px 0 #000, 0 1px #000, 0 -1px #000,
      1px 1px #000, -1px 1px #000, 1px -1px #000, -1px -1px #000,
      2px 0 #000, -2px 0 #000, 0 2px #000, 0 -2px #000,
      2px 1px #000, -2px 1px #000, 2px -1px #000, -2px -1px #000,
      1px 2px #000, -1px 2px #000, 1px -2px #000, -1px -2px #000;
  }

  /* 가판대 모달 */
  .shop{display:none;position:fixed;inset:0;backdrop-filter:blur(3px);background:rgba(0,0,0,.45);place-items:center;z-index:50}
  .shop .card{background:#0f141a;border:1px solid #2f3945;border-radius:16px;padding:16px;max-width:460px;width:calc(100% - 24px)}
  .shop .status{display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:#0c1218;border:1px solid #23303c;border-radius:12px;padding:8px 10px;margin-bottom:10px}
  .status .badge{padding:6px 8px;border-radius:10px;background:#091018;border:1px solid #23303c;font-size:13px}
  .shop .item{display:flex;justify-content:space-between;align-items:center;margin:8px 0;padding:10px;border:1px dashed #2b3641;border-radius:12px}
  .shop .item .name{display:flex;align-items:center;gap:10px}
  .shop .item .icon{width:22px;height:22px;image-rendering:pixelated}
  .shop .counts{font-size:12px;color:#9fb0c2;margin-top:4px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill" id="day">Day 1</div>
      <div class="pill" id="money">$ 200</div>
      <div class="pill" id="selectedPill">선택: 없음</div>
      <div class="grow"></div>
      <button class="btn" id="btnInventory">🎒 인벤토리</button>
      <button class="btn btn-accent" id="btnShop">가판대</button>
      <button class="btn btn-house" id="btnNext">🏠 다음날</button>
    </div>

    <div class="board-wrap">
      <div class="board" id="board">
        <div id="grid" class="grid" aria-label="6x6 밭"></div>
        <div id="player" style="left:50%; top:50%"></div>
      </div>
      <div class="legend">
        <h3>도움말</h3>
        <div class="row"><span class="kbd">탭</span> 타일 → 캐릭터가 이동해서 심기/수확</div>
        <div class="row small">씨앗 선택은 상단 **인벤토리(🎒)** 에서 아이콘 탭</div>
      </div>
    </div>
  </div>

  <!-- 인벤토리 -->
  <div class="inventory" id="inventory">
    <div class="card">
      <h2>인벤토리 (4×2)</h2>
      <div class="inventory-grid">
        <!-- 8칸: 1 토마토, 1 감자, 6 빈칸 (원하면 확장해도 됨) -->
        <button class="slot" data-item="tomato" id="slotTomato" title="토마토">
          <span class="label">토마토</span>
          <img src="IMG_4636.png" alt="토마토">
          <span class="count" id="invTomatoCnt">0</span>
        </button>
        <button class="slot" data-item="potato" id="slotPotato" title="감자">
          <span class="label">감자</span>
          <img src="IMG_4637.png" alt="감자">
          <span class="count" id="invPotatoCnt">0</span>
        </button>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="btnCloseInventory">닫기</button>
      </div>
    </div>
  </div>

  <!-- 가판대 -->
  <div class="shop" id="shop">
    <div class="card">
      <h2>가판대</h2>
      <div class="status">
        <div class="badge" id="shopMoney">보유 금액: $ 200</div>
        <div class="badge" id="shopTomato">토마토 씨앗: 0개</div>
        <div class="badge" id="shopPotato">감자 씨앗: 0개</div>
      </div>
      <div class="item">
        <div class="name">
          <img src="IMG_4636.png" class="icon" alt="토마토">
          <div>
            <strong>토마토 씨앗</strong>
            <div class="small">성장 3일 · 판매 $30</div>
            <div class="counts" id="shopTomatoInline">보유: 0개</div>
          </div>
        </div>
        <button class="btn btn-accent" data-buy="tomato">구매 $10</button>
      </div>
      <div class="item">
        <div class="name">
          <img src="IMG_4637.png" class="icon" alt="감자">
          <div>
            <strong>감자 씨앗</strong>
            <div class="small">성장 5일 · 판매 $50</div>
            <div class="counts" id="shopPotatoInline">보유: 0개</div>
          </div>
        </div>
        <button class="btn btn-accent" data-buy="potato">구매 $15</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="btnCloseShop">닫기</button>
      </div>
    </div>
  </div>

<script>
// ====== iOS 더블탭 줌 방지 ======
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e){
  const now = Date.now();
  if (now - lastTouchEnd <= 350) { e.preventDefault(); }
  lastTouchEnd = now;
}, {passive:false});

// ====== 데이터 ======
const CROPS = {
  tomato:{id:'tomato',name:'토마토',growDays:3,seedPrice:10,sellPrice:30,img:'IMG_4636.png'},
  potato:{id:'potato',name:'감자',growDays:5,seedPrice:15,sellPrice:50,img:'IMG_4637.png'}
};
let state={day:1,money:200,selected:null,seeds:{tomato:0,potato:0},tiles:[]};

// ====== 요소 ======
const $day=document.getElementById('day'),$money=document.getElementById('money'),$selectedPill=document.getElementById('selectedPill');
const $grid=document.getElementById('grid'),$board=document.getElementById('board'),$player=document.getElementById('player');
const $btnInventory=document.getElementById('btnInventory'),$inventory=document.getElementById('inventory'),
      $btnCloseInventory=document.getElementById('btnCloseInventory'),$slotTomato=document.getElementById('slotTomato'),$slotPotato=document.getElementById('slotPotato'),
      $invTomatoCnt=document.getElementById('invTomatoCnt'),$invPotatoCnt=document.getElementById('invPotatoCnt');
const $shop=document.getElementById('shop'),$btnShop=document.getElementById('btnShop'),$btnNext=document.getElementById('btnNext'),$btnCloseShop=document.getElementById('btnCloseShop');
const $shopMoney=document.getElementById('shopMoney'),$shopTomato=document.getElementById('shopTomato'),$shopPotato=document.getElementById('shopPotato'),
      $shopTomatoInline=document.getElementById('shopTomatoInline'),$shopPotatoInline=document.getElementById('shopPotatoInline');

// ====== 캐릭터 이동 상태 ======
const player = { x:0,y:0, tx:0,ty:0, speed:240, moving:false };
let pendingAction = null;    // {type:'plant'|'harvest', idx}
const ARRIVE_DIST = 20;

// ====== 초기화 (6×6) ======
function init(){
  state.tiles=Array.from({length:36},()=>({cropId:null,grown:0,phase:'empty'}));

  const frag=document.createDocumentFragment();
  for(let i=0;i<36;i++){
    const tile=document.createElement('div');
    tile.className='tile'; tile.dataset.idx=i;
    applyTileStyle(tile,state.tiles[i]);
    tile.addEventListener('click', onTileTap, {passive:true});
    frag.appendChild(tile);
  }
  $grid.appendChild(frag);

  // 플레이어 초기 위치
  const gRect = $grid.getBoundingClientRect();
  const bRect = $board.getBoundingClientRect();
  const cx = (gRect.left + gRect.right)/2 - bRect.left;
  const cy = gRect.bottom - bRect.top;
  player.x = cx; player.y = cy; player.tx = cx; player.ty = cy;
  placePlayer();

  refreshUI();
  requestAnimationFrame(loop);
}
document.addEventListener('DOMContentLoaded', init);

// ====== UI ======
function refreshUI(){
  $day.textContent=`Day ${state.day}`;
  $money.textContent=`$ ${state.money}`;

  // 선택 표시
  const selName = state.selected ? (state.selected==='tomato'?'토마토':'감자') : '없음';
  $selectedPill.textContent = `선택: ${selName}`;

  // 인벤토리 수량
  $invTomatoCnt.textContent = state.seeds.tomato;
  $invPotatoCnt.textContent = state.seeds.potato;

  // 슬롯 선택 하이라이트
  $slotTomato.classList.toggle('selected', state.selected==='tomato');
  $slotPotato.classList.toggle('selected', state.selected==='potato');

  // 가판대 배지/인라인
  updateShopUI();
}
function updateShopUI(){
  $shopMoney.textContent=`보유 금액: $ ${state.money}`;
  $shopTomato.textContent=`토마토 씨앗: ${state.seeds.tomato}개`;
  $shopPotato.textContent=`감자 씨앗: ${state.seeds.potato}개`;
  $shopTomatoInline.textContent=`보유: ${state.seeds.tomato}개`;
  $shopPotatoInline.textContent=`보유: ${state.seeds.potato}개`;
}
function applyTileStyle(el,data){
  el.dataset.state=data.phase;
  el.style.backgroundSize='cover';
  el.style.backgroundPosition='center';
  if(data.phase==='empty'){
    el.style.backgroundImage='none';
    el.style.backgroundColor=getComputedStyle(document.documentElement).getPropertyValue('--soil');
  } else if(data.phase==='growing'){
    el.style.backgroundImage='url("IMG_4638.png")';
    el.style.backgroundColor='#6b8f4e';
  } else if(data.phase==='ready'){
    const img=CROPS[data.cropId].img;
    el.style.backgroundImage=`url("${img}")`;
    el.style.backgroundColor='transparent';
  }
}
function tileEl(i){ return $grid.children[i]; }

// ====== 인벤토리 열기/선택 ======
$btnInventory.addEventListener('click',()=>{ $inventory.style.display='grid'; });
$btnCloseInventory.addEventListener('click',()=>{ $inventory.style.display='none'; });
// 배경 탭으로 닫기
$inventory.addEventListener('click',(e)=>{ if(e.target===$inventory) $inventory.style.display='none'; });
// 슬롯 클릭으로 선택
$slotTomato.addEventListener('click',()=>{ state.selected='tomato'; $inventory.style.display='none'; refreshUI(); });
$slotPotato.addEventListener('click',()=>{ state.selected='potato'; $inventory.style.display='none'; refreshUI(); });

// ====== 가판대 ======
$btnShop.addEventListener('click',()=>{ updateShopUI(); $shop.style.display='grid'; });
$btnCloseShop.addEventListener('click',()=> $shop.style.display='none');
$shop.addEventListener('click',(e)=>{
  if(e.target===$shop){ $shop.style.display='none'; return; }
  const btn=e.target.closest('[data-buy]'); if(!btn) return;
  const id=btn.getAttribute('data-buy'), crop=CROPS[id];
  btn.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}],{duration:160});
  if(state.money>=crop.seedPrice){
    state.money -= crop.seedPrice;
    state.seeds[id] += 1;
    refreshUI();          // 인벤토리 숫자/가판대 동기화
  } else {
    btn.animate([{transform:'translateX(0)'},{transform:'translateX(-3px)'},{transform:'translateX(3px)'},{transform:'translateX(0)'}],{duration:200});
  }
});

// ====== 다음날 ======
$btnNext.addEventListener('click',()=>{
  state.day++;
  for(let i=0;i<state.tiles.length;i++){
    const t=state.tiles[i];
    if(t.phase==='growing' && t.cropId){
      t.grown++;
      if(t.grown>=CROPS[t.cropId].growDays) t.phase='ready';
      applyTileStyle(tileEl(i),t);
    }
  }
  refreshUI();
});

// ====== 캐릭터 이동 루프 ======
let lastTs = performance.now();
function loop(ts){
  const dt = Math.min(0.05, (ts - lastTs)/1000);
  lastTs = ts;

  const dx = player.tx - player.x;
  const dy = player.ty - player.y;
  const dist = Math.hypot(dx, dy);

  if(dist > 0.5){
    player.moving = true;
    const step = Math.min(dist, player.speed * dt);
    player.x += dx/dist * step;
    player.y += dy/dist * step;
    placePlayer();
    if(dist <= ARRIVE_DIST && pendingAction){
      performPendingAction();
      pendingAction = null;
    }
  }else{
    player.moving = false;
    if(pendingAction){ performPendingAction(); pendingAction = null; }
  }
  requestAnimationFrame(loop);
}
function placePlayer(){ $player.style.left=`${player.x}px`; $player.style.top=`${player.y}px`; }
function tileCenterPx(tile){
  const tr = tile.getBoundingClientRect();
  const br = $board.getBoundingClientRect();
  return { x: tr.left - br.left + tr.width/2, y: tr.top - br.top + tr.height/2 };
}
function distancePlayerTo(pt){ return Math.hypot(player.x - pt.x, player.y - pt.y); }

// ====== 타일 탭: 이동 → 심기/수확 ======
function onTileTap(e){
  const idx=+e.currentTarget.dataset.idx, t=state.tiles[idx];
  const center = tileCenterPx(e.currentTarget);
  player.tx = center.x; player.ty = center.y + 6;

  if(t.phase==='empty'){
    if(!state.selected || state.seeds[state.selected]<=0) return;
    if(distancePlayerTo(center) <= ARRIVE_DIST) plantAt(idx, e.currentTarget);
    else pendingAction = {type:'plant', idx};
  } else if(t.phase==='ready'){
    if(distancePlayerTo(center) <= ARRIVE_DIST) harvestAt(idx, e.currentTarget);
    else pendingAction = {type:'harvest', idx};
  }
}
function plantAt(idx, el){
  const t=state.tiles[idx];
  if(t.phase!=='empty') return;
  if(!state.selected || state.seeds[state.selected]<=0) return;
  state.seeds[state.selected]--;
  t.cropId=state.selected; t.grown=0; t.phase='growing';
  applyTileStyle(el,t); refreshUI();
}
function harvestAt(idx, el){
  const t=state.tiles[idx]; if(t.phase!=='ready') return;
  const crop=CROPS[t.cropId]; state.money+=crop.sellPrice;
  t.cropId=null; t.grown=0; t.phase='empty';
  applyTileStyle(el,t); refreshUI();
}
function performPendingAction(){
  const el = tileEl(pendingAction.idx);
  if(pendingAction.type==='plant') plantAt(pendingAction.idx, el);
  else if(pendingAction.type==='harvest') harvestAt(pendingAction.idx, el);
}
</script>
</body>
</html>
